blueprint:
  name: Dynamische Notify Service met Thuisstatus
  description: >-
    Configureerbare melding naar een specifieke ontvanger of automatisch op basis van thuisstatus.
    Alle notify-services en aanwezigheidssensors worden door de gebruiker ingesteld.
  domain: script
  input:
    recipients:
      name: Ontvangersconfiguratie
      description: >
        Configureer notify-services en bijbehorende sensors voor elke ontvanger.
        Voeg elke ontvanger toe als een object met `notify_service` en `home_sensor`.
      default: []
      selector:
        object: {}
    recipient_mode:
      name: Ontvanger keuze
      description: Wie moet de melding ontvangen? Specifieke ontvanger, iedereen of automatisch.
      selector:
        select:
          mode: dropdown
          options:
            - label: Specifieke ontvanger
              value: specifiek
            - label: Iedereen
              value: iedereen
            - label: Automatisch (op basis van thuisstatus)
              value: automatisch
      default: iedereen
    title:
      name: Titel
      description: Titel van de melding
      selector:
        text: {}
      required: true
    message:
      name: Bericht
      description: De inhoud van de notificatie
      selector:
        text:
          multiline: true
      required: true
    group:
      name: Groep
      description: Groepeer notificaties
      selector:
        text: null
    tag:
      name: Tag
      description: Notificaties met dezelfde tag worden vervangen
      selector:
        text: null
    image:
      name: Afbeelding
      description: URL van een afbeelding om bij te voegen
      selector:
        text: {}
    camera:
      name: Camera
      description: Selecteer een camera-entiteit
      selector:
        entity:
          domain: camera
    actions:
      name: Acties
      description: Optionele acties voor de notificatie
      selector:
        object: {}
    interruption_level:
      name: Attentiewaarde
      description: De prioriteit van de notificatie
      selector:
        select:
          options:
            - label: Normaal
              value: active
            - label: Stil
              value: passive
            - label: Belangrijk
              value: time-sensitive
            - label: Kritiek
              value: critical
      default: active
    url:
      name: URL
      description: De notificatie opent...
      selector:
        text: null

sequence:
  - variables:
      notify_services: >
        {% set services = [] %}
        {% if recipient_mode == 'iedereen' %}
          {% for recipient in recipients %}
            {% set services = services + [recipient.notify_service] %}
          {% endfor %}
        {% elif recipient_mode == 'specifiek' %}
          {% for recipient in recipients %}
            {% set services = services + [recipient.notify_service] %}
          {% endfor %}
        {% elif recipient_mode == 'automatisch' %}
          {% set all_home = true %}
          {% for recipient in recipients %}
            {% if is_state(recipient.home_sensor, 'on') %}
              {% set services = services + [recipient.notify_service] %}
            {% else %}
              {% set all_home = false %}
            {% endif %}
          {% endfor %}
          {% if all_home == false %}
            {% for recipient in recipients %}
              {% set services = services + [recipient.notify_service] %}
            {% endfor %}
          {% endif %}
        {% endif %}
        {{ services }}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ notify_services | length > 0 }}"
        sequence:
          - repeat:
              for_each: "{{ notify_services }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: !input title
                    message: !input message
                    data:
                      group: !input group
                      tag: !input tag
                      image: !input image
                      actions: !input actions
                      push:
                        interruption-level: "{{ interruption_level }}"