blueprint:
  name: ㆝ Dynamische Notify Service
  description: >
    Configureerbare melding naar een specifieke ontvanger of automatisch aan de hand van sensorgegevens.
    Alle entiteiten en notify-services worden door de gebruiker ingesteld.
  domain: script
  input:
  title:
    name: Titel
    description: Titel van de melding.
    selector:
      text: {}
  message:
    name: Bericht
    description: Inhoud van de melding.
    selector:
      text: {}
  group:
    name: Groep
    description: Groepeer notificaties.
    selector:
      text: {}
    default: ""  # Maak optioneel door een lege string als default in te stellen
  tag:
    name: Tag
    description: Notificaties met dezelfde tag worden vervangen.
    selector:
      text: {}
    default: ""  # Maak optioneel door een lege string als default in te stellen
  image:
    name: Afbeelding
    description: URL van een afbeelding om bij te voegen.
    selector:
      text: {}
    default: ""  # Maak optioneel door een lege string als default in te stellen
  camera:
    name: Camera
    description: Selecteer een camera-entiteit.
    selector:
      entity:
        domain: camera
    default: null  # Maak optioneel door null in te stellen
  actions:
    name: Acties
    description: Optionele acties voor de notificatie.
    selector:
      object: {}
    default: {}  # Maak optioneel door een lege waarde te definiëren
  interruption_level:
    name: Attentiewaarde
    description: Prioriteitsniveau van de melding.
    default: active
    selector:
      select:
        mode: dropdown
        options:
          - label: Normaal
            value: active
          - label: Stil
            value: passive
          - label: Belangrijk
            value: time-sensitive
          - label: Kritiek
            value: critical

mode: single

variables:
  recipients: !input recipients
  recipient_mode: !input recipient
sequence:
  - variables:
      notify_services: >
        {% set services = [] %}
        {% if recipient_mode == 'iedereen' %}
          {% for recipient in recipients %}
            {% set services = services + [recipient.notify_service] %}
          {% endfor %}
        {% elif recipient_mode == 'specifiek' %}
          {% for recipient in recipients %}
            {% set services = services + [recipient.notify_service] %}
          {% endfor %}
        {% elif recipient_mode == 'automatisch' %}
          {% for recipient in recipients %}
            {% if is_state(recipient.home_sensor, 'on') %}
              {% set services = services + [recipient.notify_service] %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ services }}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ notify_services | length > 0 }}"
        sequence:
          - repeat:
              for_each: "{{ notify_services }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: !input title
                    message: !input message
                    data:
                      group: !input group
                      tag: !input tag
                      image: !input image
                      actions: !input actions
                      push:
                        interruption-level: "{{ interruption_level }}"